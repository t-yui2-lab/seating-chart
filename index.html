<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座席配置オートメーション 6.8 (修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        window.Firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #4f46e5; cursor: pointer; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .block-container { background-color: #f8fafc; border: 2px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05), 0 10px 15px -3px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative; }
        .seat-empty { background-color: #ffffff; border: 1px solid #dee2e6; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .seat-disabled { background-color: #e2e8f0 !important; border: 2px dashed #cbd5e1 !important; color: #64748b !important; opacity: 0.6; }
        .seat-reserved { background-color: #fffbeb !important; border: 2px solid #fbbf24 !important; color: #b45309 !important; box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        .dragging { opacity: 0.4; transform: scale(0.95); z-index: 50; }
        .drop-target { border: 3px solid #6366f1 !important; background-color: #eef2ff !important; transform: scale(1.05); z-index: 30; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PRIORITY_LABELS = { type: '雇用形態 (役職ランク順)', code: '社員番号 (社歴順)', dept: '所属部署' };
        const RANK_ORDER = ['役員', '総合職', 'TK職', '業務職', 'AP職', 'K職'];

        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                layout: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
                zap: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
                undo: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
                rotate: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
                upload: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                save: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                share: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" x2="12" y2="15"/></svg>,
                trash: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
                ban: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>,
                plus: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
                search: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                up: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"/></svg>,
                mouse: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="5" y="2" width="14" height="20" rx="7"/><line x1="12" y1="6" x2="12" y2="10"/></svg>,
                star: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
                select: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="10" x="3" y="7" rx="2"/><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            // --- State ---
            const [employees, setEmployees] = useState([]);
            const [employeeInput, setEmployeeInput] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [seatSize, setSeatSize] = useState(90);
            const [isDraggingFile, setIsDraggingFile] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [draggedKey, setDraggedKey] = useState(null); 
            const [dropTargetKey, setDropTargetKey] = useState(null); 
            const [limitCount, setLimitCount] = useState(60); 
            const [sortPriority, setSortPriority] = useState(['type', 'code', 'dept']); 
            const [placementPattern, setPlacementPattern] = useState('full'); 
            const [selectedSeat, setSelectedSeat] = useState(null); 
            const [disabledSeats, setDisabledSeats] = useState(new Set()); 
            const [reservedSeats, setReservedSeats] = useState(new Set()); 
            const [editMode, setEditMode] = useState('swap'); 
            const [assignments, setAssignments] = useState({});
            const [undoStack, setUndoStack] = useState([]); 
            const [blocks, setBlocks] = useState([{ id: 1, name: '中央メインブロック', rows: 8, cols: 6, capacity: 48 }]);
            const [isSelecting, setIsSelecting] = useState(false);
            const [selectionStart, setSelectionStart] = useState(null);
            const [selectionEnd, setSelectionEnd] = useState(null);
            const [statusMessage, setStatusMessage] = useState({ text: '', type: '' });
            const [isViewMode, setIsViewMode] = useState(false);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'seating-automation-app-v6';
            const db = useRef(null);

            // --- Computed Values (Fixed reference by moving to the top) ---
            const stats = useMemo(() => {
                const total = blocks.reduce((sum, b) => sum + b.capacity, 0);
                const usable = total - disabledSeats.size;
                const assigned = Object.keys(assignments).length;
                return { total, usable, assigned, remaining: usable - assigned };
            }, [blocks, assignments, disabledSeats]);

            // --- Helper Functions ---
            const getSeatStyles = (emp, isSelected, isHit, isSysReserved) => {
                if (isSysReserved) return { backgroundColor: '#fffbeb', borderColor: '#fbbf24', borderStyle: 'solid', borderWidth: '2px' };
                if (!emp) return { backgroundColor: '#ffffff', borderColor: '#cbd5e1' };
                const type = (emp.type || "").trim();
                let style = { backgroundColor: '#ffffff', borderColor: '#94a3b8', borderWidth: '2px' };
                if (type.includes('役員')) { style.backgroundColor = '#be123c'; style.borderColor = '#fb7185'; style.color = '#ffffff'; } 
                else if (type.includes('総合職')) { style.backgroundColor = '#fdf2f8'; style.borderColor = '#f472b6'; } 
                else if (type.includes('TK')) { style.backgroundColor = '#eef2ff'; style.borderColor = '#818cf8'; } 
                else if (type.includes('業務')) { style.backgroundColor = '#f0f9ff'; style.borderColor = '#38bdf8'; } 
                else if (type.includes('AP') || type.includes('K')) { style.backgroundColor = '#f8fafc'; style.borderColor = '#94a3b8'; }
                if (isSelected || isHit) { style.boxShadow = '0 0 0 6px rgba(99, 102, 241, 0.4)'; style.transform = 'translateY(-4px) scale(1.05)'; style.borderColor = '#6366f1'; style.zIndex = '40'; }
                return style;
            };

            const pushToUndo = (current) => setUndoStack(prev => [JSON.stringify(current), ...prev].slice(0, 20));

            // --- Effects ---
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'view') setIsViewMode(true);

                const initFirebase = async () => {
                    if (typeof window.Firebase === 'undefined') {
                        setTimeout(initFirebase, 500); 
                        return;
                    }
                    if (typeof __firebase_config === 'undefined') return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, onSnapshot } = window.Firebase;
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    db.current = getFirestore(app);
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth error", e); }
                    const layoutDocRef = doc(db.current, 'artifacts', appId, 'public', 'data', 'layouts', 'main');
                    onSnapshot(layoutDocRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.data();
                            setAssignments(data.assignments || {});
                            setBlocks(data.blocks || []);
                            setDisabledSeats(new Set(data.disabledSeats || []));
                            setReservedSeats(new Set(data.reservedSeats || []));
                            setLimitCount(data.limitCount || 60);
                        }
                    }, (err) => console.error("Firestore Sync Error:", err));
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (statusMessage.text) {
                    const timer = setTimeout(() => setStatusMessage({ text: '', type: '' }), 5000);
                    return () => clearTimeout(timer);
                }
            }, [statusMessage]);

            const showStatus = (text, type) => setStatusMessage({ text, type });

            // --- Event Handlers ---
            const handleUndo = () => {
                if (undoStack.length === 0) return showStatus("履歴がありません", "error");
                const [last, ...rest] = undoStack;
                setAssignments(JSON.parse(last));
                setUndoStack(rest);
                showStatus("元に戻しました。", "success");
            };

            const handleMouseDown = (e, blockId, index) => {
                if (editMode !== 'range' || isViewMode) return;
                setIsSelecting(true);
                setSelectionStart({ blockId, index, x: e.clientX, y: e.clientY });
                setSelectionEnd({ x: e.clientX, y: e.clientY, index });
            };

            const handleMouseMove = (e) => {
                if (!isSelecting) return;
                setSelectionEnd(prev => ({ ...prev, x: e.clientX, y: e.clientY }));
            };

            const handleMouseEnterSeat = (idx) => {
                if (!isSelecting) return;
                setSelectionEnd(prev => ({ ...prev, index: idx }));
            };

            const finalizeRangeSelection = () => {
                if (!selectionStart || selectionEnd?.index === undefined) return;
                pushToUndo(assignments);
                const blockId = selectionStart.blockId;
                const block = blocks.find(b => b.id === blockId);
                const i1 = selectionStart.index, i2 = selectionEnd.index;
                const r1 = Math.floor(i1 / block.cols), c1 = i1 % block.cols;
                const r2 = Math.floor(i2 / block.cols), c2 = i2 % block.cols;
                const minR = Math.min(r1, r2), maxR = Math.max(r1, r2);
                const minC = Math.min(c1, c2), maxC = Math.max(c1, c2);

                const nextReserved = new Set(reservedSeats);
                const nextAssignments = { ...assignments };
                for (let r = minR; r <= maxR; r++) {
                    for (let c = minC; c <= maxC; c++) {
                        const key = `${blockId}-${r * block.cols + c}`;
                        if (!disabledSeats.has(key)) {
                            if (nextReserved.has(key)) nextReserved.delete(key);
                            else { nextReserved.add(key); delete nextAssignments[key]; }
                        }
                    }
                }
                setReservedSeats(nextReserved);
                setAssignments(nextAssignments);
                setSelectionStart(null);
                setSelectionEnd(null);
            };

            const onDragStart = (key) => { if (isViewMode || editMode !== 'swap') return; setDraggedKey(key); };
            const onDragOverTarget = (e, key) => { e.preventDefault(); if (isViewMode || editMode !== 'swap' || disabledSeats.has(key)) return; setDropTargetKey(key); };
            const onDragLeave = () => setDropTargetKey(null);
            const onDropOnSeat = (e, targetKey) => {
                e.preventDefault();
                if (isViewMode || editMode !== 'swap' || !draggedKey || draggedKey === targetKey) { setDraggedKey(null); setDropTargetKey(null); return; }
                pushToUndo(assignments);
                const next = { ...assignments };
                const sourceEmp = next[draggedKey], targetEmp = next[targetKey];
                if (sourceEmp) {
                    next[targetKey] = sourceEmp;
                    if (targetEmp) next[draggedKey] = targetEmp;
                    else delete next[draggedKey];
                }
                setAssignments(next);
                setDraggedKey(null); setDropTargetKey(null);
            };

            const handleSave = async () => {
                const { doc, setDoc } = window.Firebase;
                if (!db.current) return showStatus("接続設定がありません", "error");
                setIsSaving(true);
                try {
                    const layoutDocRef = doc(db.current, 'artifacts', appId, 'public', 'data', 'layouts', 'main');
                    await setDoc(layoutDocRef, { 
                        assignments, blocks, disabledSeats: Array.from(disabledSeats), reservedSeats: Array.from(reservedSeats),
                        limitCount, updatedAt: new Date().toISOString() 
                    });
                    showStatus("クラウドに保存しました。", "success");
                } catch (e) { showStatus("保存エラー", "error"); }
                finally { setIsSaving(false); }
            };

            const copyAttendeeUrl = () => {
                const url = new URL(window.location.href); url.searchParams.set('mode', 'view');
                const textArea = document.createElement("textarea"); textArea.value = url.toString(); document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); showStatus("来場者用URLをコピーしました。", "success"); } 
                catch (err) { console.error('Copy failed', err); }
                document.body.removeChild(textArea);
            };

            const processFile = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "" });
                        const parsedList = rawData.slice(1).map((row, i) => {
                            if (!String(row[1] || "").trim()) return null;
                            return { id: `ex-${Date.now()}-${i}`, code: String(row[0] || "").trim(), name: String(row[1]).trim(), type: String(row[2] || "").trim(), dept: String(row[3] || "").trim() };
                        }).filter(Boolean);
                        setEmployees(parsedList);
                        setEmployeeInput(parsedList.map(e => `${e.code}\t${e.name}\t${e.type}\t${e.dept}`).join('\n'));
                        showStatus(`${parsedList.length}名を読み込みました。`, 'success');
                    } catch (e) { showStatus("読込エラー", "error"); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleParseManual = () => {
                const list = employeeInput.trim().split('\n').map((l, i) => {
                    const p = l.split(/[\t\s]+/).filter(x => x.trim());
                    return p.length < 2 ? null : { id: `m-${Date.now()}-${i}`, code: p[0]||'', name: p[1]||'', type: p[2]||'', dept: p[3]||'' };
                }).filter(Boolean);
                setEmployees(list); setAssignments({});
                showStatus(`${list.length}名を反映しました。`, 'success');
            };

            const handleSmartAutoAssign = () => {
                let list = employees.length > 0 ? [...employees] : employeeInput.trim().split('\n').map((l, i) => {
                    const p = l.split(/[\t\s]+/).filter(x => x.trim());
                    return p.length < 2 ? null : { id: `m-${Date.now()}-${i}`, code: p[0]||'', name: p[1]||'', type: p[2]||'', dept: p[3]||'' };
                }).filter(Boolean);
                if (list.length === 0) return showStatus("名簿が空です。", "error");
                pushToUndo(assignments);
                list.sort((a, b) => {
                    for (const key of sortPriority) {
                        if (key === 'type') {
                            const getRank = (t) => {
                                for(let i=0; i<RANK_ORDER.length; i++) if(t.includes(RANK_ORDER[i])) return i;
                                return 99;
                            };
                            const ra = getRank(a.type), rb = getRank(b.type);
                            if (ra !== rb) return ra - rb;
                        } else if (key === 'code') {
                            const d = a.code.localeCompare(b.code, undefined, {numeric: true});
                            if (d !== 0) return d;
                        } else if (key === 'dept') {
                            const d = a.dept.localeCompare(b.dept, 'ja');
                            if (d !== 0) return d;
                        }
                    }
                    return 0;
                });
                const filtered = list.slice(0, limitCount);
                const next = {}; let curEmp = 0;
                blocks.forEach(b => {
                    for(let r = 0; r < b.rows; r++) {
                        for(let c = 0; c < b.cols; c++) {
                            const s = r * b.cols + c; const k = `${b.id}-${s}`;
                            if (disabledSeats.has(k) || reservedSeats.has(k)) continue;
                            let skipByPattern = false;
                            if (placementPattern === 'skip') { if ((r + c) % 2 !== 0) skipByPattern = true; } 
                            else if (placementPattern === 'desk2-3') { if (c % 3 === 1) skipByPattern = true; }
                            if (!skipByPattern && curEmp < filtered.length) {
                                next[k] = filtered[curEmp]; curEmp++;
                            }
                        }
                    }
                });
                setAssignments(next);
                showStatus(`${curEmp}名を配置しました。予約席はキープされています。`, "success");
            };

            const handleSeatClick = (blockId, index) => {
                if (isViewMode || editMode === 'range') return;
                const key = `${blockId}-${index}`;
                if (editMode === 'block') {
                    pushToUndo(assignments);
                    const next = new Set(disabledSeats);
                    if (next.has(key)) next.delete(key); 
                    else { 
                        next.add(key); 
                        const na = {...assignments}; delete na[key]; setAssignments(na); 
                        const nr = new Set(reservedSeats); nr.delete(key); setReservedSeats(nr);
                    }
                    setDisabledSeats(next);
                } else {
                    if (disabledSeats.has(key)) return;
                    if (!selectedSeat) setSelectedSeat({ blockId, index });
                    else {
                        pushToUndo(assignments);
                        const k1 = `${selectedSeat.blockId}-${selectedSeat.index}`, k2 = key;
                        const na = {...assignments}, t = na[k1]; na[k1] = na[k2]; na[k2] = t;
                        if(!na[k1]) delete na[k1]; if(!na[k2]) delete na[k2];
                        setAssignments(na); setSelectedSeat(null);
                    }
                }
            };

            const updateBlock = (id, f, v) => setBlocks(blocks.map(b => (b.id === id ? { ...b, [f]: v, capacity: f==='rows'||f==='cols' ? (f==='rows'?v:b.rows)*(f==='cols'?v:b.cols) : b.capacity } : b)));
            const addBlock = () => setBlocks([...blocks, { id: Date.now(), name: `島 ${blocks.length + 1}`, rows: 5, cols: 6, capacity: 30 }]);
            const removeBlock = (id) => blocks.length > 1 && setBlocks(blocks.filter(b => b.id !== id));
            const movePriorityToTop = (key) => setSortPriority(prev => [key, ...prev.filter(k => k !== key)]);

            return (
                <div className={`p-4 md:p-8 max-w-[1800px] mx-auto min-h-screen ${isViewMode ? 'bg-slate-50' : 'bg-slate-100'}`} onMouseMove={handleMouseMove} onMouseUp={() => { if(isSelecting) finalizeRangeSelection(); setIsSelecting(false); }}>
                    {showResetConfirm && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white p-10 rounded-[40px] shadow-2xl max-w-sm w-full border text-center animate-in">
                                <h3 className="text-2xl font-black mb-6 italic text-slate-800">配置を全てクリアしますか？</h3>
                                <div className="flex gap-4">
                                    <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-4 rounded-2xl bg-slate-100 font-bold text-slate-600">戻る</button>
                                    <button onClick={() => { pushToUndo(assignments); setAssignments({}); setReservedSeats(new Set()); setShowResetConfirm(false); }} className="flex-1 py-4 rounded-2xl bg-rose-600 text-white font-bold shadow-lg shadow-rose-200">リセット</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="mb-8 flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                        <div className="flex items-center gap-5">
                            <div className="bg-indigo-600 text-white p-4 rounded-[24px] shadow-xl shadow-indigo-200"><Icon name="layout" className="w-10 h-10" /></div>
                            <div>
                                <h1 className="text-3xl md:text-5xl font-black text-slate-800 tracking-tighter italic leading-none uppercase">座席配置 Ver 6.8</h1>
                                <div className="flex items-center gap-3 mt-3">
                                    <div className="status-card border-indigo-100 bg-indigo-50/50"><span className="text-[9px] font-black text-indigo-400">総座席数</span><span className="text-lg font-black text-indigo-700">{stats.total}</span></div>
                                    <div className="status-card border-slate-100 bg-white"><span className="text-[9px] font-black text-slate-400">配置済</span><span className="text-lg font-black text-indigo-700">{stats.assigned}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap gap-4 bg-white p-4 rounded-[36px] shadow-xl border border-slate-200/50 font-bold">
                            {!isViewMode ? (
                                <>
                                    <button onClick={handleUndo} disabled={undoStack.length === 0} className={`px-5 py-3 text-sm font-bold rounded-2xl transition-all flex items-center gap-2 ${undoStack.length === 0 ? 'text-slate-200' : 'text-indigo-600 hover:bg-indigo-50'}`}><Icon name="undo" />戻す</button>
                                    <button onClick={() => setShowResetConfirm(true)} className="px-5 py-3 text-sm font-bold text-rose-600 hover:bg-rose-50 rounded-2xl flex items-center gap-2"><Icon name="rotate" />リセット</button>
                                    <button onClick={handleSave} disabled={isSaving} className={`px-8 py-3 text-sm font-black bg-emerald-600 text-white rounded-2xl shadow-lg flex items-center gap-2 ${isSaving ? 'opacity-50' : 'hover:bg-emerald-700 hover:scale-105 active:scale-95'} transition-all`}><Icon name="save" /> {isSaving ? '保存中...' : '保存して公開'}</button>
                                    <button onClick={copyAttendeeUrl} className="px-6 py-3 text-sm font-bold bg-white border border-slate-200 rounded-2xl flex items-center gap-2 hover:bg-slate-50 active:scale-95 transition-all"><Icon name="share" /> URLコピー</button>
                                    <button onClick={handleSmartAutoAssign} className="px-10 py-3 text-sm font-black bg-indigo-600 text-white rounded-2xl shadow-xl flex items-center gap-3 hover:bg-indigo-700 active:scale-95 shadow-indigo-200 transition-all"><Icon name="zap" className="w-5 h-5" /> 自動配置</button>
                                </>
                            ) : (
                                <div className="flex items-center gap-4 px-4 py-1">
                                    <Icon name="search" className="text-indigo-400" />
                                    <p className="text-sm font-bold text-slate-500 italic">名前を検索して座席を確認してください</p>
                                </div>
                            )}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className={`lg:col-span-3 space-y-6 ${isViewMode ? 'hidden lg:block' : ''}`}>
                            <div className="bg-white p-7 rounded-[40px] shadow-lg border border-slate-200/60 space-y-5">
                                <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2 pb-2 border-b border-slate-50"><Icon name="search" className="w-3 h-3"/> 操作・検索</h3>
                                <div className="relative pt-2">
                                    <input type="text" placeholder="名前を入力..." className="w-full p-5 pl-14 bg-slate-50 border-2 border-slate-100 rounded-[28px] outline-none focus:border-indigo-500 font-black transition-all text-lg shadow-inner" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                    <div className="absolute left-5 top-8 text-indigo-400"><Icon name="search" className="w-6 h-6" /></div>
                                </div>
                                {!isViewMode && (
                                    <div className="grid grid-cols-3 gap-2 font-bold text-[10px] pt-4 border-t border-slate-50">
                                        <button onClick={() => setEditMode('swap')} className={`py-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${editMode === 'swap' ? 'border-indigo-600 bg-indigo-50 text-indigo-600 shadow-sm' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}><Icon name="layout" /><span>移動</span></button>
                                        <button onClick={() => setEditMode('block')} className={`py-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${editMode === 'block' ? 'border-rose-600 bg-rose-50 text-rose-600 shadow-sm' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}><Icon name="ban" /><span>封鎖</span></button>
                                        <button onClick={() => setEditMode('range')} className={`py-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${editMode === 'range' ? 'border-amber-600 bg-amber-50 text-amber-600 shadow-sm' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}><Icon name="select" /><span>範囲指定</span></button>
                                    </div>
                                )}
                            </div>

                            {!isViewMode && (
                                <>
                                    <div className="bg-white p-7 rounded-[40px] shadow-lg border border-slate-200/60 space-y-5">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2 pb-2 border-b border-slate-50"><Icon name="zap" className="w-3 h-3"/> 1. 自動配置ルール</h3>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black text-slate-400 uppercase ml-1 block">配置パターン</label>
                                            <div className="grid grid-cols-1 gap-2">
                                                <button onClick={() => setPlacementPattern('full')} className={`py-2.5 px-4 rounded-2xl text-[10px] font-bold border-2 transition-all ${placementPattern === 'full' ? 'border-indigo-600 bg-indigo-50 text-indigo-600' : 'border-slate-100 text-slate-400'}`}>すべて埋める</button>
                                                <button onClick={() => setPlacementPattern('skip')} className={`py-2.5 px-4 rounded-2xl text-[10px] font-bold border-2 transition-all ${placementPattern === 'skip' ? 'border-indigo-600 bg-indigo-50 text-indigo-600' : 'border-slate-100 text-slate-400'}`}>一つ飛ばし</button>
                                                <button onClick={() => setPlacementPattern('desk2-3')} className={`py-2.5 px-4 rounded-2xl text-[10px] font-bold border-2 transition-all ${placementPattern === 'desk2-3' ? 'border-indigo-600 bg-indigo-50 text-indigo-600' : 'border-slate-100 text-slate-400'}`}>3人掛け両端</button>
                                            </div>
                                        </div>
                                        <div className="pt-4 border-t border-slate-50">
                                            <label className="text-[11px] font-black text-slate-400 uppercase ml-1">一般配置人数</label>
                                            <input type="number" value={limitCount} onChange={(e) => setLimitCount(parseInt(e.target.value)||0)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-[20px] font-black text-xl text-center text-indigo-600 focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        </div>
                                    </div>

                                    <div className="bg-white p-7 rounded-[40px] shadow-lg border border-slate-200/60 space-y-5">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2 pb-2 border-b border-slate-50"><Icon name="upload" className="w-3 h-3"/> 2. 名簿読込</h3>
                                        <label className={`flex flex-col items-center justify-center w-full h-32 border-3 border-dashed rounded-[32px] cursor-pointer transition-all ${isDraggingFile ? 'bg-indigo-50 border-indigo-500 shadow-inner' : 'border-slate-200 hover:bg-slate-50'}`} onDragOver={e=>{e.preventDefault();setIsDraggingFile(true)}} onDragLeave={()=>setIsDraggingFile(false)} onDrop={e=>{e.preventDefault();setIsDraggingFile(false);processFile(e.dataTransfer.files[0])}}>
                                            <Icon name="upload" className="text-slate-400 w-6 h-6 mb-2" />
                                            <span className="text-[11px] font-black text-slate-500">Excel/CSVをドロップ</span>
                                            <input type="file" className="hidden" accept=".xlsx,.csv" onChange={e => processFile(e.target.files[0])} />
                                        </label>
                                        <textarea className="w-full h-40 p-4 text-[10px] font-mono bg-slate-50 border border-slate-200 rounded-[24px] outline-none overflow-x-auto" value={employeeInput} onChange={(e) => setEmployeeInput(e.target.value)} />
                                        <button onClick={handleParseManual} className="w-full py-3 bg-slate-800 text-white rounded-2xl font-black text-[11px] shadow-lg active:scale-95 transition-all">反映（手動修正）</button>
                                    </div>

                                    <div className="bg-white p-7 rounded-[40px] shadow-lg border border-slate-200/60 space-y-5">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2 pb-2 border-b border-slate-50"><Icon name="plus" className="w-3 h-3"/> 3. 会場構成</h3>
                                        <div className="space-y-3 max-h-60 overflow-auto pr-2 custom-scrollbar">
                                            {blocks.map(b => (
                                                <div key={b.id} className="p-5 bg-slate-50 rounded-[28px] border border-slate-200 relative group/blk shadow-sm">
                                                    <button onClick={() => removeBlock(b.id)} className="absolute top-3 right-3 opacity-0 group-hover/blk:opacity-100 text-slate-300 hover:text-rose-500 transition-all"><Icon name="trash" /></button>
                                                    <input className="bg-transparent border-none text-[12px] font-black w-full p-0 text-slate-700 focus:ring-0" value={b.name} onChange={e => updateBlock(b.id, 'name', e.target.value)} />
                                                    <div className="flex gap-3 mt-3 text-center">
                                                        <div className="flex-1"><label className="text-[9px] text-slate-400 font-bold block uppercase tracking-tighter">Rows</label><input type="number" className="w-full p-2 bg-white text-xs border rounded-xl font-bold" value={b.rows} onChange={e => updateBlock(b.id, 'rows', parseInt(e.target.value)||1)} /></div>
                                                        <div className="flex-1"><label className="text-[9px] text-slate-400 font-bold block uppercase tracking-tighter">Cols</label><input type="number" className="w-full p-2 bg-white text-xs border rounded-xl font-bold" value={b.cols} onChange={e => updateBlock(b.id, 'cols', parseInt(e.target.value)||1)} /></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={addBlock} className="w-full py-4 border-2 border-dashed border-indigo-200 rounded-[24px] text-indigo-500 text-[11px] font-black active:scale-95 flex items-center justify-center gap-2 transition-all hover:bg-indigo-50"><Icon name="plus" /> ブロック追加</button>
                                        <div className="pt-4 border-t border-slate-50">
                                            <input type="range" min="70" max="160" value={seatSize} onChange={e => setSeatSize(parseInt(e.target.value))} className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Main View Area */}
                        <div className="lg:col-span-9 bg-white rounded-[80px] shadow-2xl border border-slate-200/50 p-6 md:p-12 min-h-[1000px] overflow-auto relative select-none">
                            <div className="max-w-4xl mx-auto mb-24 relative">
                                <div className="bg-slate-800 text-white py-8 rounded-b-[50px] font-black text-center shadow-2xl tracking-[1.5em] text-lg relative z-20 border-b-8 border-slate-900 uppercase">Stage / ステージ</div>
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-40 bg-indigo-500/5 blur-[80px] rounded-full pointer-events-none"></div>
                            </div>
                            
                            <div className="flex flex-wrap justify-center gap-20 relative z-10">
                                {blocks.map(b => (
                                    <div key={b.id} className="text-center animate-in">
                                        <h4 className="mb-6 text-[12px] font-black text-slate-400 uppercase tracking-[0.4em] flex items-center justify-center gap-3">{b.name}</h4>
                                        <div className="grid gap-3 p-10 block-container rounded-[56px]" style={{ gridTemplateColumns: `repeat(${b.cols}, minmax(0, 1fr))` }}>
                                            {Array.from({ length: b.capacity }).map((_, i) => {
                                                const key = `${b.id}-${i}`, emp = assignments[key], hit = searchTerm && emp?.name.includes(searchTerm), dis = disabledSeats.has(key), isSel = selectedSeat?.blockId === b.id && selectedSeat?.index === i;
                                                const res = reservedSeats.has(key);
                                                const seatStyle = getSeatStyles(emp, isSel, hit, res);
                                                
                                                // 範囲選択中の強調表示
                                                const isInSelection = isSelecting && selectionStart?.blockId === b.id && ( (r, c, r1, c1, r2, c2) => {
                                                    const minR = Math.min(r1, r2), maxR = Math.max(r1, r2);
                                                    const minC = Math.min(c1, c2), maxC = Math.max(c1, c2);
                                                    return r >= minR && r <= maxR && c >= minC && c <= maxC;
                                                })(Math.floor(i/b.cols), i%b.cols, Math.floor(selectionStart.index/b.cols), selectionStart.index%b.cols, Math.floor((selectionEnd?.index??selectionStart.index)/b.cols), (selectionEnd?.index??selectionStart.index)%b.cols);

                                                return (
                                                    <div 
                                                        key={i} 
                                                        draggable={!isViewMode && emp && editMode === 'swap'} 
                                                        onDragStart={() => onDragStart(key)} 
                                                        onDragOver={(e) => onDragOverTarget(e, key)} 
                                                        onDragLeave={onDragLeave} 
                                                        onDrop={(e) => onDropOnSeat(e, key)} 
                                                        onMouseDown={(e) => handleMouseDown(e, b.id, i)}
                                                        onMouseEnter={() => handleMouseEnterSeat(i)}
                                                        onClick={() => handleSeatClick(b.id, i)} 
                                                        className={`transition-all duration-300 flex flex-col items-center justify-center border relative group cursor-pointer rounded-[28px] shadow-sm 
                                                            ${dis ? 'seat-disabled' : res ? 'seat-reserved' : !emp ? 'seat-empty' : ''} 
                                                            ${draggedKey === key ? 'dragging' : ''} 
                                                            ${dropTargetKey === key ? 'drop-target' : ''}
                                                            ${isInSelection ? 'ring-4 ring-indigo-500 ring-offset-2 z-50' : ''}
                                                        `} 
                                                        style={{ width: `${seatSize}px`, height: `${seatSize}px`, ...(!dis ? seatStyle : {}) }}
                                                    >
                                                        {dis ? (<Icon name="ban" className="w-5 h-5 opacity-50" />) : res ? (
                                                            <div className="flex flex-col items-center gap-0.5">
                                                                <Icon name="star" className="w-4 h-4 text-amber-500 shadow-sm" />
                                                                <span className="text-[9px] font-black tracking-tighter text-amber-600">受賞者席</span>
                                                            </div>
                                                        ) : emp ? (
                                                            <div className="px-3 text-center w-full overflow-hidden select-none">
                                                                <div className={`font-black leading-tight mb-1 truncate w-full ${seatSize < 90 ? 'text-[10px]' : 'text-[13px]'}`}>{emp.name}</div>
                                                                <div className={`font-black tracking-tighter truncate w-full opacity-70 ${seatSize < 90 ? 'text-[7px]' : 'text-[9px]'}`}>{emp.dept}</div>
                                                            </div>
                                                        ) : ( !isViewMode && <div className="w-2 h-2 rounded-full bg-slate-200 group-hover:bg-indigo-300 transition-all border border-slate-200" /> )}
                                                        <div className="absolute top-2 right-2 text-[6px] font-black opacity-10 group-hover:opacity-100 transition-opacity tracking-tighter">{Math.floor(i/b.cols)+1}-{(i%b.cols)+1}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
